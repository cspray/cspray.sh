#!/bin/bash

if [ ! -f "/run/media/$USER/Secure_Key/pass_key_priv.gpg" ] || [ ! -f "/run/media/$USER/Secure_Key/pass_key_pub.gpg" ]; then
  echo -n "Expected to find GPG key for password-store available in /run/media/$USER/Secure_Key but nothing was found. "
  echo "Please ensure that the appropriate encrypted USB key has been mounted to the correct path"
  exit 255
fi

echo "Configuring SSH & GPG keys!"
echo "Stay near your computer as you'll need to provide passwords for SSH."

if [ -d "$HOME/.gnupg" ]; then
  echo "Existing GPG keys found. Will not migrate existing key!"
else
  echo "Importing existing GPG key..."
  gpg --import "/run/media/$USER/Secure_Key/pass_key_pub.gpg"
  gpg --allow-secret-key-import --import "/run/media/$USER/Secure_Key/pass_key_priv.gpg"
fi

if [ -f "$HOME/.ssh/id_ed25519" ]; then
  echo "Existing SSH key found, will not create new key!"
else
  echo "Creating new SSH key..."
  ssh-keygen -t ed25519 -f "$HOME/.ssh/id_ed25519" -C "me@cspray.io"
  eval "$(ssh-agent -s)" &> /dev/null
  ssh-add "$HOME/.ssh/id_ed25519"
  echo "SSH key created and added to SSH agent!"
fi
